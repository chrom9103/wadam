name: Auto Tagging

on:
    pull_request:
        types: [closed]

permissions:
    contents: write

jobs:
    tagging:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        outputs:
          new_tag: ${{ steps.create_tag.outputs.NEW_TAG }}
          bump_type: ${{ steps.bump_type.outputs.BUMP }}
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                fetch-depth: 0
                token: ${{ secrets.PAT }}
            - name: Get labels
              id: get_labels
              run: |
                LABELS="${{ join(github.event.pull_request.labels.*.name, ',')}}"
                echo "LABELS=$LABELS" >> $GITHUB_ENV
            - name: Determine bump type
              id: bump_type
              run: |
                if [[ "$LABELS" == *"major"* ]]; then
                  echo "BUMP=major" >> $GITHUB_OUTPUT
                elif [[ "$LABELS" == *"minor"* ]]; then
                  echo "BUMP=minor" >> $GITHUB_OUTPUT
                elif [[ "$LABELS" == *"patch"* ]]; then
                  echo "BUMP=patch" >> $GITHUB_OUTPUT
                else
                  echo "No version bump label found."
                  echo "BUMP=none" >> $GITHUB_OUTPUT
                fi
            - name: Get latest tag
              id: get_latest_tag
              if: steps.bump_type.outputs.BUMP != 'none'
              run: |
                LATEST_TAG=$(git tag --list 'v*.*.*' --sort=-v:refname | head -1)
                if [ -z "$LATEST_TAG" ]; then
                  LATEST_TAG="v0.0.0"
                fi
                echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
            - name: Bump version and create tag
              if: steps.bump_type.outputs.BUMP != 'none'
              id: create_tag
              run: |
                CURRENT_VERSION=${LATEST_TAG#v}
                IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
                MAJOR=${VERSION_PARTS[0]}
                MINOR=${VERSION_PARTS[1]}
                PATCH=${VERSION_PARTS[2]}
                case "${{ steps.bump_type.outputs.BUMP }}" in
                  major)
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                    ;;
                  minor)
                    MINOR=$((MINOR + 1))
                    PATCH=0
                    ;;
                  patch)
                    PATCH=$((PATCH + 1))
                    ;;
                esac
                NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
                echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
            - name: Push new tag
              if: steps.bump_type.outputs.BUMP != 'none'
              run: |
                NEW_TAG="${{ steps.create_tag.outputs.NEW_TAG }}"
                if [ -z "$NEW_TAG" ]; then
                  echo "ERROR: NEW_TAG is empty"
                  exit 1
                fi
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git tag "$NEW_TAG"
                git push origin "$NEW_TAG"